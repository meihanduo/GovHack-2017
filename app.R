library(shiny)
library(leaflet)
library(RColorBrewer)
library(tidyverse)

options(shiny.trace=FALSE)
ui <- bootstrapPage(
  tags$style(type="text/css","html,body {width:100%;height:100%}"),
  titlePanel("The Best Estimate of Sydney Transport", tags$style (align = "centre")),
  leafletOutput("map", width = "100%", height = "100%"),
  
  absolutePanel(top = 100, right = 10,
             sliderInput("changeInTraffic","Percentage Change in Drivers",
                 min = -50,
                 max = 200,
                 value = 0,
                 step = 10,
                 post = "%"),
              checkboxInput("legend", "Show legend", TRUE),
             "Scale: Red is congested and Green is uncongested"
                
           
  )
)


server <- function(input, output, session) {
  testData <- read_csv("\"\",\"Lat\",\"Lon\",\"Hour\",\"AverageCars\",\"AverageSpeedPercentage\",\"minus50\",\"minus40\",\"minus30\",\"minus20\",\"minus10\",\"noChange\",\"plus10\",\"plus20\",\"plus30\",\"plus40\",\"plus50\",\"plus60\",\"plus70\",\"plus80\",\"plus90\",\"plus100\",\"plus110\",\"plus120\",\"plus130\",\"plus140\",\"plus150\",\"plus160\",\"plus170\",\"plus180\",\"plus190\",\"plus200\"
\"1\",-33.93,151.21,8,3105.113,0.6047265625,0.744455501681224,0.751715324848338,0.758975148015452,0.766234971182566,0.77349479434968,0.780754617516794,0.788014440683907,0.795274263851021,0.802534087018135,0.809793910185249,0.817053733352363,0.824313556519477,0.831573379686591,0.838833202853704,0.846093026020818,0.853352849187932,0.860612672355046,0.86787249552216,0.875132318689274,0.882392141856388,0.889651965023501,0.896911788190615,0.904171611357729,0.911431434524843,0.918691257691957,0.925951080859071\n
\"2\",-33.89,151.22,8,402.4034,0.55,0.424250389419042,0.434805054559033,0.445359719699025,0.455914384839016,0.466469049979007,0.477023715118999,0.48757838025899,0.498133045398982,0.508687710538973,0.519242375678965,0.529797040818956,0.540351705958947,0.550906371098939,0.56146103623893,0.572015701378922,0.582570366518913,0.593125031658905,0.603679696798896,0.614234361938887,0.624789027078879,0.63534369221887,0.645898357358862,0.656453022498853,0.667007687638844,0.677562352778836,0.688117017918827\n
\"3\",-33.88,151.09,8,350.681,0.95,0.770764868669238,0.774874659580278,0.778984450491317,0.783094241402357,0.787204032313397,0.791313823224437,0.795423614135476,0.799533405046516,0.803643195957556,0.807752986868595,0.811862777779635,0.815972568690674,0.820082359601714,0.824192150512754,0.828301941423794,0.832411732334833,0.836521523245873,0.840631314156913,0.844741105067952,0.848850895978992,0.852960686890031,0.857070477801071,0.861180268712111,0.86529005962315,0.86939985053419,0.87350964144523\n
\"4\",-33.87,151.06,8,346.6167,0.431947544642857,0.432298093702314,0.444350279127095,0.456402464551875,0.468454649976656,0.480506835401437,0.492559020826217,0.504611206250998,0.516663391675779,0.52871557710056,0.54076776252534,0.552819947950121,0.564872133374902,0.576924318799683,0.588976504224463,0.601028689649244,0.613080875074025,0.625133060498806,0.637185245923586,0.649237431348367,0.661289616773148,0.673341802197929,0.685393987622709,0.69744617304749,0.709498358472271,0.721550543897052,0.733602729321832\n
\"5\",-33.87,151.13,8,661.52065,0.498712287527594,0.441296507229467,0.45351457279912,0.465732638368772,0.477950703938424,0.490168769508077,0.502386835077729,0.514604900647382,0.526822966217034,0.539041031786686,0.551259097356339,0.563477162925991,0.575695228495644,0.587913294065296,0.600131359634948,0.612349425204601,0.624567490774253,0.636785556343906,0.649003621913558,0.66122168748321,0.673439753052863,0.685657818622515,0.697875884192168,0.71009394976182,0.722312015331472,0.734530080901125,0.746748146470777\n
\"6\",-33.87,151.2,8,2528.952,0.512472403311258,0.521429447498573,0.519793294951004,0.518157142403435,0.516520989855866,0.514884837308297,0.513248684760728,0.511612532213159,0.50997637966559,0.508340227118021,0.506704074570452,0.505067922022883,0.503431769475314,0.501795616927745,0.500159464380176,0.498523311832607,0.496887159285038,0.495251006737469,0.4936148541899,0.491978701642331,0.490342549094762,0.488706396547193,0.487070243999624,0.485434091452055,0.483797938904486,0.482161786356917,0.480525633809348\n
\"7\",-33.86,151.07,8,953.887633333333,0.442082123349468,0.480297257002397,0.50224981566068,0.524202374318963,0.546154932977245,0.568107491635528,0.59006005029381,0.612012608952093,0.633965167610376,0.655917726268658,0.677870284926941,0.699822843585224,0.721775402243506,0.743727960901789,0.765680519560071,0.787633078218354,0.809585636876637,0.831538195534919,0.853490754193202,0.875443312851484,0.897395871509767,0.91934843016805,0.941300988826332,0.963253547484615,0.985206106142897,1.00715866480118,1.02911122345946\n
\"8\",-33.86,151.21,8,1529.74985,0.63672480620155,0.572553546885589,0.579173792347351,0.585794037809112,0.592414283270874,0.599034528732636,0.605654774194397,0.612275019656159,0.61889526511792,0.625515510579682,0.632135756041444,0.638756001503205,0.645376246964967,0.651996492426728,0.65861673788849,0.665236983350252,0.671857228812013,0.678477474273775,0.685097719735536,0.691717965197298,0.69833821065906,0.704958456120821,0.711578701582583,0.718198947044345,0.724819192506106,0.731439437967868,0.738059683429629\n
\"9\",-33.85,151.21,8,1988.375,1.2970468675275,1.42311609047997,1.38359126702522,1.34406644357048,1.30454162011574,1.26501679666099,1.22549197320625,1.1859671497515,1.14644232629676,1.10691750284202,1.06739267938727,1.02786785593253,0.988343032477785,0.948818209023041,0.909293385568297,0.869768562113553,0.830243738658809,0.790718915204065,0.751194091749321,0.711669268294577,0.672144444839833,0.63261962138509,0.593094797930346,0.553569974475602,0.514045151020858,0.474520327566114,0.43499550411137\n
\"10\",-33.84,151.21,8,1402.85,0.803731167608286,0.805522251771902,0.791554416648539,0.777586581525176,0.763618746401813,0.749650911278451,0.735683076155088,0.721715241031725,0.707747405908362,0.693779570784999,0.679811735661637,0.665843900538274,0.651876065414911,0.637908230291548,0.623940395168186,0.609972560044823,0.59600472492146,0.582036889798097,0.568069054674734,0.554101219551372,0.540133384428009,0.526165549304646,0.512197714181283,0.498229879057921,0.484262043934558,0.470294208811195,0.456326373687832\n
\"11\",-33.82,151.09,8,1428.475,0.516666666666667,0.460364515043007,0.465298457059483,0.470232399075959,0.475166341092434,0.48010028310891,0.485034225125386,0.489968167141862,0.494902109158338,0.499836051174814,0.50476999319129,0.509703935207766,0.514637877224242,0.519571819240717,0.524505761257193,0.529439703273669,0.534373645290145,0.539307587306621,0.544241529323097,0.549175471339573,0.554109413356049,0.559043355372525,0.563977297389001,0.568911239405476,0.573845181421952,0.578779123438428,0.583713065454904\n
")
  
  # set data to update when user changes values
  
  # render map
  output$map <- renderLeaflet({
    leaflet(testData) %>%
      addProviderTiles("OpenMapSurfer.Grayscale") %>%
      # Centred around eastern Sydney
      fitBounds(~151.2111, ~-33.891, ~151.217, ~-33.877)
  })
  
  
  #input<- list()
  #input$changeInTraffic <- 70
  filteredData <- reactive({
    testData2 <- testData %>%
      mutate (plotData = 0)
    testData2[,"plotData"] <- testData2[,input$changeInTraffic*0.1 + 12]
    
    testData2$plotData <- testData2$plotData - 0.3
    
    testData2a <- testData2 %>%
      filter(plotData <= 1)
    
    testData2b <- testData2 %>%
      filter(plotData > 1)
    
    if (nrow(testData2b)> 0) {
      testData2b$plotData <- 1
    } 
    
    
    testData2 <- bind_rows(testData2a, testData2b)
    
    
    testData2
    
  }) 

  observe({
    pal <- colorNumeric(
      palette = c("red", "green"),
      domain = c(0,1))
    
    leafletProxy("map", data = filteredData()) %>%
      clearShapes() %>%
      # Circles Or CircleMarkers
      addCircles(radius = 1000, popup = ~paste(plotData), color = ~pal(plotData))
    

  })
 


}

if (FALSE) {
  observe({
    proxy <- leafletProxy("map", data = testData)
    proxy %>% clearControls()
    if (input$legend) {
      pal <- colorNumeric(
        palette = c("red", "green"),
        domain = c("high","low"))
      
      proxy %>% addLegend(position = "bottomright",
                          pal = pal, values = c(0,1), title = "Congestion",labFormat = labFormat(type = "factor"), bin = 7
      )
    }
  })
}

shinyApp(ui, server)


